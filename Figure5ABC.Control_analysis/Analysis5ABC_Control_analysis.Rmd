---
title: "Analysis5ABC_Control_analysis"
author: "Xiaochun Han"
date: "2025-12-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
source("../utils/functions_library.R")
load_packages(c("dplyr", "caret", "e1071","ggplot2", "pROC", "reshape2", "rstatix","pROC"))
```


## Pseudo_pair_control
```{r permute_pseudo}
dataset_pseudo <- read.csv('Pseudo_pair_control.csv',header=TRUE,sep=",")
acc_low_25 = sort(dataset_pseudo$perm_acc)[25]
acc_top_25 = sort(dataset_pseudo$perm_acc)[975]
dataset_pseudo$ci95 = rep(0,1000)
dataset_pseudo$ci95[(dataset_pseudo$perm_acc<acc_low_25|dataset_pseudo$perm_acc>acc_top_25)] = 1
acc_all = 0.9212
p_perm = mean(acc_all<dataset_pseudo$perm_acc)
print(p_perm)

p<-ggplot(dataset_pseudo, aes(x = (perm_acc-acc_all), fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 30) + 
    scale_fill_manual(values = c("white","#B095C6"))+ theme_classic()+xlim(-0.4,0.1) +
    geom_vline(aes(xintercept = 0), color = "#4C4C4C", linewidth = 1, linetype = "dashed") + 
    labs(x = "Decreased Accuracy") + theme(text = element_text(size = 15),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
ggsave("Pseudo_pair_control.png", plot = p, width = 5, height = 4, dpi = 300)
```

## Circular_time_control
```{r permute_circular}
dataset_circular <- read.csv('Circular_time_control.csv',header=TRUE,sep=",")
acc_low_25 = sort(dataset_circular$perm_acc)[25]
acc_top_25 = sort(dataset_circular$perm_acc)[975]
dataset_circular$ci95 = rep(0,1000)
dataset_circular$ci95[(dataset_circular$perm_acc<acc_low_25|dataset_circular$perm_acc>acc_top_25)] = 1
acc_all = 0.9212
p_perm = mean(acc_all<dataset_circular$perm_acc)
print(p_perm)

p<-ggplot(dataset_circular, aes(x = (perm_acc-acc_all), fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 20) + 
    scale_fill_manual(values = c("white","#B095C6")) +
    geom_vline(aes(xintercept = 0), color = "#4C4C4C", linewidth = 1, linetype = "dashed") + theme_classic()+xlim(-0.2,0.1) + 
    labs(x = "Decreased Accuracy") + theme(text = element_text(size = 15),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
ggsave("Circular_time_control.png", plot = p, width = 5, height = 4, dpi = 300)
```

## Match 12 trial
### Import data
```{r import_data}
setwd('../Data/Develop')
wd<-getwd()
dataset_BOLD <- read.csv('BOLD_single_trial_invest.csv',header=TRUE,sep=",")
dataset_FC <- read.csv('FC_single_trial_invest.csv',header=TRUE,sep=",")
dataset_BINS <- read.csv('BINS_single_trial_invest.csv',header=TRUE,sep=",")
dataset_INS <- read.csv('INS_single_trial_invest.csv',header=TRUE,sep=",")
dataset_y <- read.csv('win_lose_and_pay_single_trial.csv',header=TRUE,sep=",")
dataset_y_attack <- dataset_y[dataset_y$role.A.1. == 1,]
dataset_y_attack <- dataset_y_attack[-c(4,14,22),] # Three sessions are deleted due to the absent of winning trial(4,22) and brain signal(14). 
```

### Inter-brain Match
#### Accuracy
```{r acc_INS&BINS}
ACC_inter = data.frame();
for (i in 1:100){
  WNS_mean = extract_match_win_lose_mean(dataset_INS,dataset_y_attack,"WNS_",12)
  BNS_mean = extract_match_win_lose_mean(dataset_BINS,dataset_y_attack,"BNS_",12)
  data_WNS_BNS_invest = cbind(WNS_mean[,c(1,3:ncol(WNS_mean))],BNS_mean[,3:ncol(BNS_mean)])
  acc_ins_bins = svm_cv_accuracy(data_WNS_BNS_invest,5,1,"radial")
  ACC_inter = rbind(ACC_inter,acc_ins_bins)
}
meanACC_inter = mean(ACC_inter[,1])
print(meanACC_inter)
```
```{r acc_INS&BINS}
ACC_all = data.frame();
for (i in 1:100){
  WNS_mean = extract_match_win_lose_mean(dataset_INS,dataset_y_attack,"WNS_",12)
  BNS_mean = extract_match_win_lose_mean(dataset_BINS,dataset_y_attack,"BNS_",12)
  BOLD_mean = extract_match_win_lose_mean(dataset_BOLD,dataset_y_attack,"BOLD_",12)
  FC_mean = extract_match_win_lose_mean(dataset_FC,dataset_y_attack,"FC_",12)
  data_all_invest = cbind(BOLD_mean[,c(1,3:ncol(BOLD_mean))],FC_mean[,3:ncol(FC_mean)],WNS_mean[,3:ncol(WNS_mean)],BNS_mean[,3:ncol(BNS_mean)])
  acc_all = svm_cv_accuracy(data_all_invest,5,1,"radial")
  ACC_all = rbind(ACC_all,acc_all)
}
meanACC_all = mean(ACC_all[,1])
print(meanACC_all)
```

#### permutation
```{r permute_INS&BINS, eval=FALSE}
permACC_inter = data.frame();
for (i in 1:5000){
  WNS_mean = extract_match_win_lose_mean(dataset_INS,dataset_y_attack,"WNS_",12)
  BNS_mean = extract_match_win_lose_mean(dataset_BINS,dataset_y_attack,"BNS_",12)
  data_WNS_BNS_invest = cbind(WNS_mean[,c(1,3:ncol(WNS_mean))],BNS_mean[,3:ncol(BNS_mean)])
  acc_ins_bins = svm_perm(data_WNS_BNS_invest,5,1,"radial")
  permACC_inter = rbind(permACC_inter,acc_ins_bins[,1])
}

saveRDS(permACC_inter, file = "SVM_win_INS_BINS_perm_5000_match_12.RData")
```

#### figure
```{r hist_INS&BINS}
acc_match_inter_perm = readRDS("SVM_win_INS_BINS_perm_5000_match_12.RData")
colnames(acc_match_inter_perm) = "acc_perm"
acc_low_25 = sort(acc_match_inter_perm$acc_perm)[125]
acc_top_25 = sort(acc_match_inter_perm$acc_perm)[4875]
acc_match_inter_perm$ci95 = rep(0,5000)
acc_match_inter_perm$ci95[(acc_match_inter_perm$acc_perm<acc_low_25|acc_match_inter_perm$acc_perm>acc_top_25)] = 1

p_match_inter_perm = mean(meanACC_inter<acc_match_inter_perm$acc_perm)
print(p_match_inter_perm)

p <- ggplot(acc_match_inter_perm, aes(x = acc_perm, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#B095C6"))+
    geom_vline(aes(xintercept = meanACC_inter), color = "#B095C6", linewidth = 2) + theme_classic()+xlim(0,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 15),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
ggsave("Match12_perm_INS_BINS.png", plot = p, width = 5, height = 4, dpi = 300)
```

### Intra-brain Match
#### Accuracy
```{r acc_BOLD&FC}
ACC_intra = data.frame();
for (i in 1:100){
  BOLD_mean = extract_match_win_lose_mean(dataset_BOLD,dataset_y_attack,"BOLD_",12)
  FC_mean = extract_match_win_lose_mean(dataset_FC,dataset_y_attack,"FC_",12)
  data_BOLD_FC_invest = cbind(BOLD_mean[,c(1,3:ncol(BOLD_mean))],FC_mean[,3:ncol(FC_mean)])
  acc_bold_fc = svm_cv_accuracy(data_BOLD_FC_invest,5,1,"radial")
  ACC_intra = rbind(ACC_intra,acc_bold_fc)
}
meanACC_intra = mean(ACC_intra[,1])
print(meanACC_intra)
```

#### permutation
```{r permute_BOLD&FC, eval=FALSE}
permACC_intra = data.frame();
for (i in 1:5000){
  print(i)
  BOLD_mean = extract_match_win_lose_mean(dataset_BOLD,dataset_y_attack,"BOLD_",12)
  FC_mean = extract_match_win_lose_mean(dataset_FC,dataset_y_attack,"FC_",12)
  data_BOLD_FC_invest = cbind(BOLD_mean[,c(1,3:ncol(BOLD_mean))],FC_mean[,3:ncol(FC_mean)])
  acc_bold_fc = svm_perm(data_BOLD_FC_invest,5,1,"radial")
  permACC_intra = rbind(permACC_intra,acc_bold_fc[,1])
}

saveRDS(permACC_intra, file = "SVM_win_BOLD_FC_perm_5000_match_12.RData")
```

#### figure
```{r hist_BOLD&FC}
acc_match_intra_perm = readRDS("SVM_win_BOLD_FC_perm_5000_match_12.RData")
colnames(acc_match_intra_perm) = "acc_perm"
acc_low_25 = sort(acc_match_intra_perm$acc_perm)[125]
acc_top_25 = sort(acc_match_intra_perm$acc_perm)[4875]
acc_match_intra_perm$ci95 = rep(0,5000)
acc_match_intra_perm$ci95[(acc_match_intra_perm$acc_perm<acc_low_25|acc_match_intra_perm$acc_perm>acc_top_25)] = 1

p_match_intra_perm = mean(meanACC_intra<acc_match_intra_perm$acc_perm)
print(p_match_intra_perm)

p <- ggplot(acc_match_intra_perm, aes(x = acc_perm, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#969796"))+
    geom_vline(aes(xintercept = meanACC_intra), color = "#969796", linewidth = 2) + theme_classic()+xlim(0,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 15),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
ggsave("Match12_perm_BOLD_FC.png", plot = p, width = 5, height = 4, dpi = 300)
```