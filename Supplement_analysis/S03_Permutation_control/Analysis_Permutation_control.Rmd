---
title: "Analysis_Permutation_control"
author: "Xiaochun Han"
date: "2025-12-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
source("../../utils/functions_library.R")
load_packages(c("dplyr", "caret", "e1071","ggplot2", "pROC", "reshape2", "rstatix","pROC"))
```

## Control analyses
```{r import data}
dataset_pseudo <- read.csv('Pseudo_pair_control.csv',header=TRUE,sep=",")
dataset_circular <- read.csv('Circular_time_control.csv',header=TRUE,sep=",")
dataset_pseudo_and_circular <- read.csv('Pseudo_pair_circular_both_control.csv',header=TRUE,sep=",")

dataset_pseudo_full <- read.csv('Pseudo_pair_full-model_control.csv',header=TRUE,sep=",")
dataset_circular_full <- read.csv('Circular_time_full-model_control.csv',header=TRUE,sep=",")
dataset_pseudo_and_circular_full <- read.csv('Pseudo_pair_circular_both_full-model_control.csv',header=TRUE,sep=",")

dataset_machine_same <- read.csv('Same_machine_control.csv',header=TRUE,sep=",")
dataset_machine_diff <- read.csv('Diff_machine_control.csv',header=TRUE,sep=",")

acc_all_trial = readRDS("SVM_win_all_trial_level_perm_1000.RData")
acc_inter_trial = readRDS("SVM_win_inter_trial_level_perm_1000.RData")
acc_intra_trial = readRDS("SVM_win_intra_trial_level_perm_1000.RData")
```

## Permutation_test
```{r import data perm}
acc_wns_bns_perm = readRDS("/Users/xiaochunhan/Documents/Research/Projects/Brains_align_to_win/Fig2CEG.Permutation_test/SVM_win_INS_BINS_perm_5000.RData")
```

### Pseudo_pair_control
```{r permute_pseudo}
acc_low_25 = sort(dataset_pseudo$Var1)[25]
acc_top_25 = sort(dataset_pseudo$Var1)[975]
dataset_pseudo$ci95 = rep(0,1000)
dataset_pseudo$ci95[(dataset_pseudo$Var1<acc_low_25|dataset_pseudo$Var1>acc_top_25)] = 1
acc_real = 0.9212
p_perm = mean(acc_real<dataset_pseudo$Var1)
print(p_perm)

p<-ggplot(dataset_pseudo, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#B095C6"))+
    geom_vline(aes(xintercept = acc_real), color = "#B095C6", linewidth = 2) + theme_classic()+xlim(0.5,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### Mann-Whiteney test
```{r MW_test}
dist_1 = dataset_pseudo$Var1
dist_2 = acc_wns_bns_perm$acc_perm
summary(dist_1)
summary(dist_2)

ks_result <- ks.test(dist_1, dist_2)
print("Kolmogorov-Smirnov检验结果:")
print(ks_result)

mw_result <- wilcox.test(dist_1, dist_2, exact = FALSE)
print("Mann-Whitney U检验结果:")
print(mw_result)
par(mfrow = c(1, 2)) # 设置画布为1行2列

# 绘制密度图
plot(density(dist_1), main = "密度分布图", col = "blue", lwd = 2, 
     xlab = "值", ylim = c(0, max(c(density(dist_1)$y, density(dist_2)$y))))
lines(density(dist_2), col = "red", lwd = 2)
legend("topright", legend = c("分布1 (n=1000)", "分布2 (n=5000)"), 
       col = c("blue", "red"), lty = 1)
```

### Pseudo_pair_full-model_control
```{r permute_pseudo_full}
acc_low_25 = sort(dataset_pseudo_full$Var1)[25]
acc_top_25 = sort(dataset_pseudo_full$Var1)[975]
dataset_pseudo_full$ci95 = rep(0,1000)
dataset_pseudo_full$ci95[(dataset_pseudo_full$Var1<acc_low_25|dataset_pseudo_full$Var1>acc_top_25)] = 1
acc_real = 0.7618
p_perm = mean(acc_real<dataset_pseudo_full$Var1)
print(p_perm)

p<-ggplot(dataset_pseudo_full, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#000000"))+
    geom_vline(aes(xintercept = acc_real), color = "#000000", linewidth = 2) + theme_classic()+xlim(0.5,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### Circular_time_control
```{r permute_circular}
acc_low_25 = sort(dataset_circular$Var1)[25]
acc_top_25 = sort(dataset_circular$Var1)[975]
dataset_circular$ci95 = rep(0,1000)
dataset_circular$ci95[(dataset_circular$Var1<acc_low_25|dataset_circular$Var1>acc_top_25)] = 1

acc_real = 0.9212
p_perm = mean(acc_real>dataset_circular$Var1)
print(p_perm)

p<-ggplot(dataset_circular, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#B095C6"))+
    geom_vline(aes(xintercept = acc_real), color = "#B095C6", linewidth = 2) + theme_classic()+xlim(0.7,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### Circular_time_full-model_control
```{r permute_circular_full}
acc_low_25 = sort(dataset_circular_full$Var1)[25]
acc_top_25 = sort(dataset_circular_full$Var1)[975]
dataset_circular_full$ci95 = rep(0,999)
dataset_circular_full$ci95[(dataset_circular_full$Var1<acc_low_25|dataset_circular_full$Var1>acc_top_25)] = 1

acc_real = 0.7618
p_perm = mean(acc_real<dataset_circular_full$Var1)
print(p_perm)

p<-ggplot(dataset_circular_full, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#000000"))+
    geom_vline(aes(xintercept = acc_real), color = "#000000", linewidth = 2) + theme_classic()+xlim(0.7,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### Pseudo_pair_and_circular_control
```{r permute_pseudo}
acc_low_25 = sort(dataset_pseudo_and_circular$Var1)[25]
acc_top_25 = sort(dataset_pseudo_and_circular$Var1)[975]
dataset_pseudo_and_circular$ci95 = rep(0,1000)
dataset_pseudo_and_circular$ci95[(dataset_pseudo_and_circular$Var1<acc_low_25|dataset_pseudo_and_circular$Var1>acc_top_25)] = 1

acc_real = 0.9212
p_perm = mean(acc_real<dataset_pseudo_and_circular$Var1)
print(p_perm)


p_perm_trial = mean(acc_inter_trial$acc_perm<dataset_pseudo_and_circular$Var1)
print(p_perm_trial)

p<-ggplot(dataset_pseudo_and_circular, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#B095C6"))+
    geom_vline(aes(xintercept = acc_real), color = "#B095C6", linewidth = 2) + theme_classic()+xlim(0.5,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### Pseudo_pair_and_circular_full-model_control
```{r permute_pseudo_full}
acc_low_25 = sort(dataset_pseudo_and_circular_full$Var1)[25]
acc_top_25 = sort(dataset_pseudo_and_circular_full$Var1)[975]
dataset_pseudo_and_circular_full$ci95 = rep(0,1000)
dataset_pseudo_and_circular_full$ci95[(dataset_pseudo_and_circular_full$Var1<acc_low_25|dataset_pseudo_and_circular_full$Var1>acc_top_25)] = 1

acc_real = 0.7618
p_perm = mean(acc_real<dataset_pseudo_and_circular_full$Var1)
print(p_perm)


p<-ggplot(dataset_pseudo_and_circular_full, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#000000"))+
    geom_vline(aes(xintercept = acc_real), color = "#000000", linewidth = 2) + theme_classic()+xlim(0.5,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### Same_machine_control
```{r permute_machine_same}
acc_low_25 = sort(dataset_machine_same$Var1)[25]
acc_top_25 = sort(dataset_machine_same$Var1)[975]
dataset_machine_same$ci95 = rep(0,1000)
dataset_machine_same$ci95[(dataset_machine_same$Var1<acc_low_25|dataset_machine_same$Var1>acc_top_25)] = 1

p_perm = mean(acc_inter_trial$acc_perm>dataset_machine_same$Var1)
print(p_perm)

p<-ggplot(dataset_machine_same, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#B095C6"))+
    geom_vline(aes(xintercept = acc_all), color = "#B095C6", linewidth = 2) + theme_classic()+xlim(0.5,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### Diff_machine_control
```{r permute_machine_diff}
acc_low_25 = sort(dataset_machine_diff$Var1)[25]
acc_top_25 = sort(dataset_machine_diff$Var1)[975]
dataset_machine_diff$ci95 = rep(0,1000)
dataset_machine_diff$ci95[(dataset_machine_diff$Var1<acc_low_25|dataset_machine_diff$Var1>acc_top_25)] = 1

p_perm = mean(acc_inter_trial$acc_perm>dataset_machine_diff$Var1)
print(p_perm)

p<-ggplot(dataset_machine_diff, aes(x = Var1, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 61) + 
    scale_fill_manual(values = c("white","#B095C6"))+
    geom_vline(aes(xintercept = acc_all), color = "#B095C6", linewidth = 2) + theme_classic()+xlim(0.5,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

#### Same_machine_control vs. Diff_machine_control
```{r permute_machine_same_diff}
p_compare = sum(dataset_machine_diff$Var1<dataset_machine_same$Var1)/1000
print(p_compare)
```

## Trial-level permutation
### Import data
```{r import_data}
setwd('../../Data/Develop')
wd<-getwd()
dataset_BOLD <- read.csv('BOLD_single_trial_invest.csv',header=TRUE,sep=",")
dataset_FC <- read.csv('FC_single_trial_invest.csv',header=TRUE,sep=",")
dataset_BINS <- read.csv('BINS_single_trial_invest.csv',header=TRUE,sep=",")
dataset_INS <- read.csv('INS_single_trial_invest.csv',header=TRUE,sep=",")
dataset_y <- read.csv('win_lose_and_pay_single_trial.csv',header=TRUE,sep=",")
dataset_y_attack <- dataset_y[dataset_y$role.A.1. == 1,]
dataset_y_attack <- dataset_y_attack[-c(4,14,22),] # Three sessions are deleted due to the absent of winning trial(4,22) and brain signal(14). 
```

### ALL
```{r acc_ALL}
acc_all_trial = readRDS("SVM_win_all_trial_level_perm_1000.RData")
acc_all = 0.7618
p_perm = mean(acc_all<acc_all_trial$acc_perm)
print(p_perm)
```

### WNC-BNC
```{r acc_INS&BINS}
acc_low_25 = sort(acc_inter_trial$acc_perm)[50]
acc_top_25 = sort(acc_inter_trial$acc_perm)[950]
acc_inter_trial$ci95 = rep(0,1000)
acc_inter_trial$ci95[(acc_inter_trial$acc_perm<acc_low_25|acc_inter_trial$acc_perm>acc_top_25)] = 1

acc_inter = 0.9212
p_perm = mean(acc_inter<acc_inter_trial$acc_perm)
print(p_perm)

p<-ggplot(acc_inter_trial, aes(x = acc_perm, fill = as.factor(ci95))) +
    geom_histogram(colour = "#4C4C4C", bins = 20) + 
    scale_fill_manual(values = c("white","#B095C6"))+
    geom_vline(aes(xintercept = acc_inter), color = "#B095C6", linewidth = 2) + theme_classic()+xlim(0.7,1) + 
    labs(x = "Win-Lose Prediction Accuracy") + theme(text = element_text(size = 25),legend.position="none",axis.ticks.length=unit(-0.1, "cm"))
print(p)
```

### BOLD-FC
```{r acc_BOLD&FC}

acc_intra = 0.5823
p_perm = mean(acc_intra<acc_intra_trial$acc_perm)
print(p_perm)
```